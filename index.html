<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Community Ball – Rarible Satelliten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script type="module" src="https://unpkg.com/@google/model-viewer@3.4.0/dist/model-viewer.min.js"></script>
  <style>
    html, body { height:100%; margin:0; background:#000; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    model-viewer { width:100%; height:100%; }
    .sat { width:84px; height:84px; border-radius:50%; border:2px solid #fff; box-shadow:0 0 10px rgba(255,255,255,.4);
           object-fit:cover; cursor:pointer; transition:transform .2s ease; }
    .sat:hover { transform: scale(1.12); }
    .hud { position:fixed; left:12px; bottom:12px; background:rgba(0,0,0,.5); padding:8px 12px; border-radius:10px; font-size:14px; }
    .hud b { color:#0ff; }
    .toast { position:fixed; top:12px; right:12px; background:#222; padding:10px 12px; border-radius:10px; border:1px solid #444; display:none; }
    .spinner { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#000; }
    .spinner::after { content:""; width:42px; height:42px; border:4px solid #333; border-top-color:#0ff; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="spinner" id="spinner"></div>
  <div class="toast" id="toast"></div>

  <model-viewer id="viewer"
    src="ball4.glb"
    alt="Community Ball"
    camera-controls
    auto-rotate
    interaction-prompt="none"
    exposure="1"
    background-color="#000">
  </model-viewer>

  <div class="hud" id="hud">Lade NFTs …</div>

  <script>
    // ====== KONFIGURATION ======
    // Deine Rarible-Collection (Polygon):
    const CHAIN = "POLYGON";
    const CONTRACT = "0xec82b796433ffb818832fb01a4fbb969768289d3"; // <- deine Adresse
    const MAX_ITEMS = 100;          // wie viele Satelliten max. anzeigen
    const RADIUS = 2.2;             // Abstand der Satelliten (in Metern, je nach GLB-Größe 1.6–3.0 testen)
    const GATEWAY = "https://ipfs.io/ipfs/"; // IPFS-Gateway für Bilder

    // ====== HILFSFUNKTIONEN ======
    const toast = (msg, ms=3500) => {
      const el = document.getElementById('toast');
      el.textContent = msg; el.style.display = 'block';
      clearTimeout(window.__t); window.__t = setTimeout(()=>{ el.style.display='none'; }, ms);
    };

    function ipfsToHttp(url) {
      if (!url) return null;
      // Rarible liefert z.T. ipfs://CID/... oder ar://
      if (url.startsWith("ipfs://")) return url.replace("ipfs://", GATEWAY);
      if (url.startsWith("ar://")) return "https://arweave.net/" + url.slice(5);
      return url;
    }

    // Gleichmäßige Verteilung auf Kugel (Fibonacci Sphere)
    function fibonacciSphere(n, r){
      const pts=[]; const PHI=(1+Math.sqrt(5))/2;
      for (let i=0;i<n;i++){
        const t=i/n, inc=Math.PI*2*(1-1/PHI);
        const z=1-2*t, rad=Math.sqrt(1-z*z), th=inc*i;
        pts.push([Math.cos(th)*rad*r, Math.sin(th)*rad*r, z*r]);
      }
      return pts;
    }

    // NFT-Detail-URL auf Rarible
    function raribleItemUrl(chain, contract, tokenId){
      const chainLower = chain.toLowerCase(); // polygon
      return `https://rarible.com/token/${chainLower}/${contract}:${tokenId}`;
    }

    // ====== RARIBLE API LADEN ======
    async function fetchCollectionItems(chain, contract) {
      // Paging: Rarible liefert max ~50 pro Seite; wir holen mehrere Seiten bis MAX_ITEMS
      const items = [];
      let continuation = null;
      try {
        while (items.length < MAX_ITEMS) {
          const url = new URL("https://api.rarible.org/v0.1/items/byCollection");
          url.searchParams.set("collection", `${chain}:${contract}`);
          url.searchParams.set("size", "50");
          if (continuation) url.searchParams.set("continuation", continuation);

          const res = await fetch(url, { headers: { "accept": "application/json" }});
          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();

          if (Array.isArray(data.items)) items.push(...data.items);
          continuation = data.continuation;
          if (!continuation || items.length >= MAX_ITEMS) break;
        }
      } catch (e) {
        console.error(e);
        toast("Fehler beim Laden der NFTs. Prüfe die Collection-Adresse oder versuche es später.");
      }
      return items.slice(0, MAX_ITEMS);
    }

    // Wählt ein bestes Bild aus der Rarible-Meta
    function pickImageUrl(item) {
      const meta = item.meta || {};
      // content kann ein Array mit Objekten sein; wir suchen erstes Image
      if (Array.isArray(meta.content)) {
        const img = meta.content.find(c => (c["@type"]?.toLowerCase?.().includes("image")) || (c.mimeType?.startsWith?.("image/")));
        if (img?.url) return ipfsToHttp(img.url);
      }
      // fallback: preview oder Bild-URL manchmal in meta.image oder meta.originalMeta
      if (meta.image) return ipfsToHttp(meta.image);
      if (meta?.originalMeta?.image) return ipfsToHttp(meta.originalMeta.image);
      return null;
    }

    function sortItemsStable(items){
      // Versuche, sinnvoll zu sortieren: nach numerischem tokenId aufsteigend
      return items.slice().sort((a,b)=>{
        const ai = parseInt(a.tokenId || a.id?.split(":").pop() || "0", 10);
        const bi = parseInt(b.tokenId || b.id?.split(":").pop() || "0", 10);
        return (isNaN(ai)?0:ai) - (isNaN(bi)?0:bi);
      });
    }

    async function buildSatellites() {
      const spinner = document.getElementById('spinner');
      const hud = document.getElementById('hud');
      const viewer = document.getElementById('viewer');

      try {
        hud.innerHTML = `Lade NFTs aus <b>${CONTRACT}</b> (Polygon)…`;
        const raw = await fetchCollectionItems(CHAIN, CONTRACT);
        if (!raw.length) {
          hud.textContent = "Keine Items gefunden (Collection leer?).";
          spinner.style.display = "none";
          return;
        }

        const items = sortItemsStable(raw)
          .map(it => {
            const img = pickImageUrl(it);
            const tokenId = it.tokenId || (it.id?.split(":").pop());
            const url = raribleItemUrl(CHAIN, CONTRACT, tokenId);
            return img ? { img, url, tokenId } : null;
          })
          .filter(Boolean)  // nur mit Bild
          .slice(0, MAX_ITEMS);

        hud.innerHTML = `Zeige <b>${items.length}</b> Items · klicken öffnet Rarible.`;

        const pts = fibonacciSphere(items.length, RADIUS);

        items.forEach((it, i) => {
          const el = document.createElement('img');
          el.src = it.img;
          el.className = 'sat';
          el.slot = `hotspot-${i}`;
          el.title = `Token #${it.tokenId}`;
          const [x,y,z] = pts[i];
          el.dataset.position = `${x} ${y} ${z}`;
          el.dataset.normal   = `${x} ${y} ${z}`;
          el.setAttribute('data-visibility-attribute', 'visible');
          el.addEventListener('click', () => window.open(it.url, '_blank', 'noopener'));
          viewer.appendChild(el);
        });

      } catch (e) {
        console.error(e);
        toast("Fehler beim Aufbau der Satelliten.");
      } finally {
        spinner.style.display = "none";
      }
    }

    // Start: erst Modell laden, dann Satelliten bauen
    document.getElementById('viewer').addEventListener('load', buildSatellites);
  </script>
</body>
</html>
